<c-col xs="12">
  <c-card class="mb-4">
    <c-card-header>
      <strong>Carga de nueva solicitud</strong> &nbsp;
      <small>Módulo para crear solicitudes de documentos académicos</small>
    </c-card-header>
    <c-card-body>
      <mat-horizontal-stepper [linear]="true" #stepper>
        <!-- Paso 1: Selección de Carrera -->
        <mat-step [stepControl]="firstFormGroup">
          <form [formGroup]="firstFormGroup">
            <ng-template matStepLabel>Programa académico</ng-template>
            <!-- Si hay más de un programa, mostrar un combo desplegable -->
            <div>
              <mat-form-field appearance="fill">
                <mat-label>Selecciona el programa académico</mat-label>
                <mat-select formControlName="carrera">
                  <mat-option *ngFor="let carrera of carreras" [value]="carrera.id_titulacion">
                    {{ carrera.programas }}
                  </mat-option>
                </mat-select>
              </mat-form-field>
            </div>
            <div align="right">
              <button matStepperNext color="accent" mat-mini-fab="" matstepperprevious="" type="button"
                class="mat-mini-fab mat-accent">
                <span class="mat-button-wrapper"><mat-icon aria-hidden="true">arrow_forward</mat-icon></span>
              </button>

            </div>
          </form>
        </mat-step>

        <!-- Paso 2: Selección de Documentos -->
        <mat-step [completed]="documentosAnnadidos.length > 0">
          <c-alert color="info" class="d-flex align-items-center mb-3">
            <svg cIcon class="me-2" width="30" height="30" name="cilInfo"></svg>
            <div>
              La solicitud del <strong>carnet estudiantil</strong> está sujeta a condiciones:
              <ul>
                <li>El sistema no permite solicitar otro documento en conjunto con el carnet. Asegúrate de hacer la solicitud del carnet por separado.</li>
                <li>Si no has cargado una foto o esta aún no ha sido validada por nuestro equipo, la solicitud del carnet no será posible.</li>
              </ul>
            </div>
        </c-alert>
        
          <form [formGroup]="secondFormGroup">
            <ng-template matStepLabel>Selección de Documentos y envio de solicitud</ng-template>

            <!-- Primera fila: Tipo de Documento y Documento Disponible -->
            <div class="row">
              <div class="col-12 col-md-6 mb-3">
                <mat-form-field appearance="fill" class="w-100">
                  <mat-label>Tipo de Documento</mat-label>
                  <mat-select formControlName="tipoDocumento" (selectionChange)="filtrarDocumentosDisponibles()">
                    <mat-option *ngFor="let tipo of tiposDocumentos" [value]="tipo.codelemento">{{ tipo.descripcion
                      }}</mat-option>
                  </mat-select>
                </mat-form-field>
              </div>

              <div class="col-12 col-md-6 mb-3">
                <mat-form-field appearance="fill" class="w-100">
                  <mat-label>Documento Disponible</mat-label>
                  <mat-select formControlName="documentoDisponible" (selectionChange)="verificarDocumentoSeleccionado()">
                    <mat-option 
                      *ngFor="let documento of documentosFiltrados" 
                      [value]="documento.id_documento" 
                      [disabled]="!cumpleRequisitoCarnet && +documento.id_documento === 6"
                      matTooltipPosition="above">
                      {{ documento.nombre_documento }} - {{ documento.costo | currency:'€ ':'symbol':'1.2-2' }}
                    </mat-option>
                  </mat-select>
                </mat-form-field>
                
              </div>              
            </div>

            <!-- Segunda fila: Formato, Cantidad, y Observaciones -->
            <div class="row">
              <div class="col-12 col-md-3 mb-3">
                <label>Formato</label>
                <mat-radio-group formControlName="formato" (change)="verificarFormato()">
                  <mat-radio-button class="me-3" value="digital">Digital</mat-radio-button>
                  <mat-radio-button value="fisico">Físico</mat-radio-button>
                </mat-radio-group>
              </div>

              <div class="col-12 col-md-3 mb-3">
                <mat-form-field appearance="fill" class="w-100">
                  <mat-label>Cantidad</mat-label>
                  <input matInput type="number" formControlName="cantidad"
                    [disabled]="secondFormGroup.get('formato')?.value === 'digital'" min="1">
                </mat-form-field>
              </div>

              <div class="col-12 col-md-6 mb-3">
                <mat-form-field appearance="fill" class="w-100">
                  <mat-label>Observaciones</mat-label>
                  <textarea matInput formControlName="observaciones"></textarea>
                </mat-form-field>
              </div>
            </div>

            <!-- Botón de agregar documento (deshabilitado hasta que el formulario esté completo) -->
            <button type="button" class="btn btn-primary mt-3" (click)="agregarDocumento()"
              [disabled]="!secondFormGroup.valid">
              <svg cIcon class="me-2" name="cil-cloud-upload"></svg>Agregar Documento
            </button>
            <br><br>

            <!-- Tabla de documentos añadidos -->
            <table mat-table [dataSource]="dataSource" [hover]="true" [responsive]="true" [striped]="true" align="middle" cTable class="mb-0 border" cTable>
              <!-- Columnas de datos -->
              <ng-container matColumnDef="tipo">
                <th mat-header-cell *matHeaderCellDef>Tipo Documento</th>
                <td mat-cell *matCellDef="let documento">{{ documento.tipoDocumento }}</td>
                <td mat-footer-cell *matFooterCellDef></td> <!-- Pie de columna vacío -->
              </ng-container>
            
              <ng-container matColumnDef="nombre">
                <th mat-header-cell *matHeaderCellDef>Nombre Documento</th>
                <td mat-cell *matCellDef="let documento">{{ documento.nombre_documento }}</td>
                <td mat-footer-cell *matFooterCellDef></td> <!-- Pie de columna vacío -->
              </ng-container>
            
              <ng-container matColumnDef="formato">
                <th mat-header-cell *matHeaderCellDef>Formato</th>
                <td mat-cell *matCellDef="let documento">{{ documento.formato }}</td>
                <td mat-footer-cell *matFooterCellDef></td> <!-- Pie de columna vacío -->
              </ng-container>
            
              <ng-container matColumnDef="cantidad">
                <th mat-header-cell *matHeaderCellDef>Cantidad</th>
                <td mat-cell *matCellDef="let documento">{{ documento.cantidad }}</td>
                <td mat-footer-cell *matFooterCellDef></td> <!-- Pie de columna vacío -->
              </ng-container>
            
              <ng-container matColumnDef="costo_unitario">
                <th mat-header-cell *matHeaderCellDef>Costo Unitario</th>
                <td mat-cell *matCellDef="let documento">{{ documento.costo_unitario | currency:'€ ':'symbol':'1.2-2' }}</td>
                <td mat-footer-cell *matFooterCellDef> <strong>Totales: </strong> </td> <!-- Pie de columna vacío -->
              </ng-container>
            
              <!-- Subtotal en Euros -->
              <ng-container matColumnDef="subtotal">
                <th mat-header-cell *matHeaderCellDef>Subtotal €</th>
                <td mat-cell *matCellDef="let documento">{{ documento.costo_total | currency:'€ ':'symbol':'1.2-2' }}</td>
                <td mat-footer-cell *matFooterCellDef><strong>{{ totalPagarEuros | currency:'€ ':'symbol':'1.2-2' }}</strong></td>
              </ng-container>
            
              <!-- Subtotal en Bolívares -->
              <ng-container matColumnDef="subtotal_bs">
                <th mat-header-cell *matHeaderCellDef>Subtotal Bs</th>
                <td mat-cell *matCellDef="let documento">{{ documento.costo_total_bs | currency:'Bs ':'symbol':'1.2-2' }}</td>
                <td mat-footer-cell *matFooterCellDef><strong>{{ totalPagarBs | currency:'Bs ':'symbol':'1.2-2' }}</strong></td>
              </ng-container>
            
              <ng-container matColumnDef="observaciones">
                <th mat-header-cell *matHeaderCellDef>Observaciones</th>
                <td mat-cell *matCellDef="let documento">{{ documento.observaciones }}</td>
                <td mat-footer-cell *matFooterCellDef></td> <!-- Pie de columna vacío -->
              </ng-container>

              <ng-container matColumnDef="accion">
                <th mat-header-cell *matHeaderCellDef>Acciones</th>
                <td mat-cell *matCellDef="let documento">
                  <button mat-icon-button color="warn" (click)="confirmarEliminarDocumento(documento)">
                    <mat-icon>delete</mat-icon>
                  </button>
                </td>
                <td mat-footer-cell *matFooterCellDef></td>
              </ng-container>
            
              <!-- Filas de encabezado, datos y pie de página -->
              <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
              <tr mat-row *matRowDef="let row; columns: displayedColumns;"></tr>
              <tr mat-footer-row *matFooterRowDef="displayedColumns"></tr>
            </table>

            <!-- Botones de navegación -->
            <div align="right" class="mt-3">
              <button matStepperPrevious color="accent" mat-mini-fab type="button"
                class="mat-mini-fab mat-accent btn btn-info ms-1">
                <span class="mat-button-wrapper"><mat-icon aria-hidden="true">arrow_back</mat-icon></span>
              </button>

              <button  cButton class="btn btn-info ms-1" [disabled]="documentosAnnadidos.length === 0" (click)="confirmarSolicitud()"><svg cIcon class="me-2" name="cil-cloud-upload"></svg>Crear solicitud</button>
            </div>
          </form>
        </mat-step>

      </mat-horizontal-stepper>

    </c-card-body>
  </c-card>
</c-col>

<ngx-spinner bdColor="rgba(51, 51, 51, 0.8)" size="default" type="ball-atom">
  <p style="color: white" align="center">Por favor espere... <br>¡Validando información!</p>
</ngx-spinner>